import json
import requests
import openai
from pathlib import Path
from django.conf import settings
from pydantic import BaseModel, Field  # ë°ì´í„° ìœ íš¨ì„±ê²€ì‚¬ + ìë™ íƒ€ì… ë³€í™˜


openai_api_key=settings.OPENAI_API_KEY

# ë¶„ì•¼ë³„ ì ìˆ˜ ê³„ì‚°
def generate_fread_analysis_score(original_text):
    class FreadAnalysisCriteria(BaseModel):
        logic: int = Field(..., gt=0, le=100)
        appeal: int = Field(..., gt=0, le=100)
        focus: int = Field(..., gt=0, le=100)
        simplicity: int = Field(..., gt=0, le=100)
        popularity: int = Field(..., gt=0, le=100)

        @property
        def total(self) -> float:
            return round(   # totalì€ ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€ ê³„ì‚°.
                (self.logic + self.appeal + self.focus + self.simplicity + self.popularity) / 5, 1
            )
        
    prompt = original_text

    try:
        client = openai.OpenAI(api_key=openai_api_key)
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": """
                        ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ë‹¤ì„¯ ê°€ì§€ í•­ëª©ì— ëŒ€í•´ ì ìˆ˜ë¥¼ ë§¤ê²¨ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ” AI í‰ê°€ìì…ë‹ˆë‹¤.

                        ê° í•­ëª©ì€ ë‹¤ìŒê³¼ ê°™ìœ¼ë©°, ê°ê° 1~100ì  ì‚¬ì´ì˜ **ì •ìˆ˜í˜• ìˆ«ì**ë¡œë§Œ ì ìˆ˜ë¥¼ ë¶€ì—¬í•´ì•¼ í•©ë‹ˆë‹¤.  
                        ì ˆëŒ€ë¡œ ì†Œìˆ˜ì ì´ë‚˜ ë²”ìœ„, í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ **ì •ìˆ˜ë§Œ ì‘ë‹µí•˜ì„¸ìš”.**

                        ---

                        ğŸ“Š í‰ê°€ í•­ëª© ë° ê¸°ì¤€ (ê° í•­ëª©ë‹¹ 1~100ì , ì •ìˆ˜):

                        1. logic (ì„¤ë“ë ¥, Persuasiveness)  
                        - ê¸€ì´ ë…ìì—ê²Œ ì–¼ë§ˆë‚˜ ë…¼ë¦¬ì ìœ¼ë¡œ ë‚©ë“ë  ìˆ˜ ìˆëŠ”ê°€ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.  
                        - ì£¼ì¥ê³¼ ê·¼ê±°ê°€ ëª…í™•í•˜ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ê°€?  
                        - ê¸€ ì „ì²´ì˜ ì „ê°œê°€ ë…¼ë¦¬ì  ìˆœì„œë¥¼ ë”°ë¥´ê³  ìˆëŠ”ê°€?  
                        - ë¶ˆí•„ìš”í•œ ê°ì •ì  í˜¸ì†Œ ì—†ì´ ë…¼ë¦¬ ìì²´ë¡œ ì„¤ë“ë ¥ì„ ê°–ì¶”ì—ˆëŠ”ê°€?  
                        - ë°˜ë¡  ê°€ëŠ¥ì„±ì„ ì¸ì§€í•˜ê³  ì´ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë¤˜ëŠ”ê°€?

                        2. appeal (ì „ë‹¬ë ¥, Clarity & Relatability)  
                        - í…ìŠ¤íŠ¸ê°€ ë…ìì—ê²Œ ì˜ë¯¸ë¥¼ ë¶„ëª…í•˜ê²Œ ì „ë‹¬í•˜ê³ , ê°ì •ì  ê³µê°ì„ ì´ëŒì–´ë‚´ëŠ” ì •ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.  
                        - í•µì‹¬ ë©”ì‹œì§€ê°€ ëª…í™•í•˜ê²Œ í‘œí˜„ë˜ì–´ ìˆëŠ”ê°€?  
                        - ë¹„ìœ , ì˜ˆì‹œ, êµ¬ì²´ì  ì–¸ì–´ë¥¼ í†µí•´ ì˜ë¯¸ê°€ ì‰¬ìš´ê°€?  
                        - ë…ìì˜ ì…ì¥ì—ì„œ ê°ì • ì´ì…ì´ ê°€ëŠ¥í•œê°€?  
                        - ë³µì¡í•œ ë‚´ìš©ì„ ì‰½ê²Œ í’€ì–´ ì“°ë ¤ëŠ” ë…¸ë ¥ì´ ìˆëŠ”ê°€?

                        3. focus (ëª°ì…ë„, Immersion)  
                        - ê¸€ì˜ íë¦„ì´ ìì—°ìŠ¤ëŸ½ê³  ë…ìê°€ ì§‘ì¤‘ë ¥ì„ ìœ ì§€í•˜ë©° ì½ì„ ìˆ˜ ìˆëŠ”ì§€ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.  
                        - í¥ë¯¸ë¡œìš´ ì „ê°œ, ê¸´ì¥ê°, ë˜ëŠ” ê¶ê¸ˆì¦ ìœ ë°œì´ ìˆëŠ”ê°€?  
                        - ì¤‘ê°„ì— ì‚°ë§Œí•˜ê±°ë‚˜ ëŠ˜ì–´ì§€ëŠ” ë¶€ë¶„ ì—†ì´ ì§‘ì¤‘ì´ ìœ ì§€ë˜ëŠ”ê°€?  
                        - ë¬˜ì‚¬ë‚˜ ì´ì•¼ê¸°ì˜ ë¦¬ë“¬ì´ ë§¤ë„ëŸ¬ìš´ê°€?  
                        - ì„œì‚¬ì  í¡ì¸ë ¥ ë˜ëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ì´ ëª°ì…ì„ ìœ ë„í•˜ëŠ”ê°€?

                        4. simplicity (ë¬¸ì¥ ê°„ê²°ì„±, Conciseness & Structure)  
                        - ë¬¸ì¥ì´ êµ°ë”ë”ê¸° ì—†ì´ í•µì‹¬ì„ ì „ë‹¬í•˜ê³ , êµ¬ì¡°ì ìœ¼ë¡œ ì •ëˆë˜ì–´ ìˆëŠ”ì§€ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.  
                        - ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì´ë‚˜ ì¤‘ë³µ í‘œí˜„ì´ ì œê±°ë˜ì–´ ìˆëŠ”ê°€?  
                        - ë¬¸ì¥ì´ ë„ˆë¬´ ê¸¸ê±°ë‚˜ ë³µì¡í•˜ì§€ ì•Šê³ , ì ì ˆí•˜ê²Œ ëŠì–´ì§€ëŠ”ê°€?  
                        - ë‹¨ë½ êµ¬ì„±ì´ ì ì ˆí•˜ë©°, ê° ë¬¸ì¥ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ”ê°€?  
                        - ì „ì²´ì ìœ¼ë¡œ ì½ê¸°ì— ë¶€ë‹´ ì—†ì´ ê¹”ë”í•œ íë¦„ì„ ê°€ì§€ëŠ”ê°€?

                        5. popularity (ëŒ€ì¤‘ì„±, Mass Appeal)  
                        - í…ìŠ¤íŠ¸ê°€ ë‹¤ì–‘í•œ ì—°ë ¹ê³¼ ë°°ê²½ì˜ ë…ìì—ê²Œ ê³µê°ê³¼ ì´í•´ë¥¼ ì¤„ ìˆ˜ ìˆëŠ”ì§€ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.  
                        - íŠ¹ì • ê³„ì¸µë§Œ ì´í•´í•  ìˆ˜ ìˆëŠ” ì „ë¬¸ ìš©ì–´ë‚˜ ë¬¸í™”ì  ë§¥ë½ì´ ì—†ëŠ”ê°€?  
                        - ì£¼ì œì™€ í‘œí˜„ì´ ë³´í¸ì ì´ë©°, ëŒ€ì¤‘ì  ì·¨í–¥ì„ ë°˜ì˜í•˜ëŠ”ê°€?  
                        - ê¸€ì´ ë„ˆë¬´ íŠ¹ìˆ˜í•˜ê±°ë‚˜ ì‹¤í—˜ì ì´ì§€ ì•Šê³ , ë„“ì€ ë…ìì¸µì´ ì½ê¸°ì— ë¶€ë‹´ì´ ì—†ëŠ”ê°€?  
                        - ì†Œí†µí•˜ë ¤ëŠ” íƒœë„ê°€ ë“œëŸ¬ë‚˜ëŠ”ê°€?


                        ğŸ“¥ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:

                        {
                        "logic": 85,
                        "appeal": 90,
                        "focus": 88,
                        "simplicity": 92,
                        "popularity": 86
                        }

                        - ëª¨ë“  ê°’ì€ 1~100 ì‚¬ì´ì˜ **ì •ìˆ˜**ì—¬ì•¼ í•©ë‹ˆë‹¤.
                        - ì ˆëŒ€ë¡œ ì„¤ëª…, ì†Œìˆ˜ì , ê¸°íƒ€ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
                        - JSON ì™¸ì—ëŠ” ì•„ë¬´ê²ƒë„ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
                        - í•œ í•­ëª©ì´ë¼ë„ ë¹ˆ ê°’ì´ ë‚˜ì™€ì„œëŠ” ì•ˆë©ë‹ˆë‹¤. ë°˜ë“œì‹œ ê°’ì„ ê³„ì‚°í•´ë‚´ì•¼ í•©ë‹ˆë‹¤.

                        ---

                        ğŸ›‘ ì¤‘ìš” ì œì•½ ì¡°ê±´:

                        - ìœ„ ë‹¤ì„¯ í•­ëª© **ì „ë¶€ ë°˜ë“œì‹œ í¬í•¨**ë˜ì–´ì•¼ í•˜ë©°, **í•˜ë‚˜ë¼ë„ ëˆ„ë½ë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.**
                        - **null, ë¹ˆ ë¬¸ìì—´, ìƒëµ, ìƒëµëœ key** ëŠ” ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        - ëª¨ë“  í•­ëª©ì˜ ê°’ì€ **ë°˜ë“œì‹œ ìœ íš¨í•œ 1~100 ì‚¬ì´ì˜ ì •ìˆ˜**ì—¬ì•¼ í•©ë‹ˆë‹¤.
                        - **ì ˆëŒ€ë¡œ JSON ì´ì™¸ì˜ í…ìŠ¤íŠ¸(ì„¤ëª…, í•´ì„, ì„œë¬¸ ë“±)ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.**
                        - ì‹œìŠ¤í…œì€ ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ ìë™ ì²˜ë¦¬í•˜ë¯€ë¡œ, ìœ„ ì¡°ê±´ì„ ì§€í‚¤ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.
                    """,
                },
                {"role": "user", "content": prompt},
            ],
            # response_format=FreadAnalysisCriteria,
            max_tokens=2040,
            temperature=0.5,
        )

        json_response = response.choices[0].message.content.strip()
        print(json_response)

        data = json.loads(json_response)    # JSON íŒŒì‹± (JSON -> dict)
        validated = FreadAnalysisCriteria(**data)  # Pydantic ëª¨ë¸ë¡œ ê²€ì¦ ë° êµ¬ì¡°í™”
        return validated
    
    except Exception as e:
        print("GPT ë¶„ì„ ì ìˆ˜ ìƒì„± ì—ëŸ¬:", e)
        return "ì ì‹œ ë¶„ì„ì´ ì›í™œí•˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
    


# ì˜ˆìƒ ëŒ“ê¸€ ìƒì„±
'''
{
age:
gender:
content:
}'''

def add_image_and_nickname(age, gender):
    return image_and_nickname

def generate_total_comments(comments_contents):
    return total_comments

comments_contents = []

def gpt(original_text, age, gender):
    prompt = original_text

    try:
        client = openai.OpenAI(api_key=openai_api_key)
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": f"""
                        ë‹¹ì‹ ì€ {age}ëŒ€ {gender} ë…ì 5ëª…ì´ ì†Œì„¤ í•œ í¸ì„ ì½ì€ í›„ ë‚¨ê¸¸ ì‹¤ì œ ëŒ“ê¸€ì„ ìƒì„±í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•˜ëŠ” AIì…ë‹ˆë‹¤.

                        - ê° ëŒ“ê¸€ì€ í•œ ì¤„ì´ë©°, ì´ëª¨í‹°ì½˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                        - ê° ëŒ“ê¸€ì€ {age}ëŒ€ {gender} ë…ìì˜ ë§íˆ¬, ê°ì •, ê´€ì‹¬ì‚¬ë¥¼ ê³ ë ¤í•˜ì—¬ ì‘ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                        - í˜„ì‹¤ì ì¸ í•œêµ­ì¸ì´ ì‘ì„±í•  ë§Œí•œ ì–´íˆ¬ì™€, ë‚´ìš©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                        - ëŒ“ê¸€ì€ ë¬¸ì¥ í•˜ë‚˜ë¡œ ëë‚´ì•¼ í•˜ë©°, ë„ˆë¬´ ì§§ì§€ë„ ê¸¸ì§€ë„ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.

                        ğŸ“¥ ë°˜ë“œì‹œ ì•„ë˜ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:

                        [
                            "ì•„ë‹ˆ ì§„ì§œ ì›ƒê¸°ê¸´ í•œë° ì£¼ì¸ê³µ ì¢€ ë‹µë‹µí•¨ğŸ¤”",
                            "ë­”ê°€ ì‘ê°€ë‹˜ì´ í•˜ì‹  ë‚¨ì£¼ ë¬˜ì‚¬ ë³´ë©´ ì—„ì²­ ì˜ìƒê²¼ì„ê±°ê°™ì§€ ì•ŠìŒ??ğŸ˜", 
                            ...
                        ]

                        ğŸ›‘ **ì¤‘ìš” ì œì•½ ì¡°ê±´**:

                        - **ëŒ“ê¸€ì€ ë°˜ë“œì‹œ 5ê°œì—¬ì•¼ í•˜ë©°**, 4ê°œ ë˜ëŠ” 6ê°œëŠ” ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        - í˜„ì‹¤ì ì¸ í•œêµ­ì¸ì´ ì‘ì„±í•  ë§Œí•œ ì–´íˆ¬ì™€, ë‚´ìš©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                        - **null, ë¹ˆ ë¬¸ìì—´, ìƒëµëœ key**ëŠ” ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        - ì‹œìŠ¤í…œì€ ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ ìë™ ì²˜ë¦¬í•˜ë¯€ë¡œ, ìœ„ ì¡°ê±´ì„ ì–´ê¸°ë©´ ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
                    """
                },
                {"role": "user", "content": prompt},
            ],
            max_tokens=2040,
            temperature=0.5,
        )

        list_response = response.choices[0].message.content.strip()
        print(list_response)

        data = json.loads(list_response)    # JSON íŒŒì‹± (JSON -> list)
        return data
    
    except Exception as e:
            print("GPT ëŒ“ê¸€ ìƒì„± ì—ëŸ¬:", e)
            return "ì ì‹œ ë¶„ì„ì´ ì›í™œí•˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
    
    

def generage_ai_comments(original_text):
    all_comments = []

    for age in [10, 20, 30, 40, 50]:
        for gender in ["male", "female"]:
            try:
                contents = call_gpt(original_text, age, gender)
                for content in contents:
                    profile = get_random_profile(gender)
                    all_comments.append({
                        "age": age,
                        "gender": gender,
                        "nickname": profile["nickname"],
                        "profile_image": profile["profile_image"],
                        "content": content
                    })
            except Exception as e:
                print(f"ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨ ({age}, {gender}):", e)

    return all_comments
